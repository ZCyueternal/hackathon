import streamlit as st
from openai import OpenAI
import os
import json
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

class ResearchEvaluator:
    """ç ”ç©¶ç”Ÿè®ºæ–‡è¿›åº¦è¯„ä¼°ç±»ï¼Œä½¿ç”¨åƒé—®APIåˆ†æç ”ç©¶è¿›åº¦"""
    
    def __init__(self):
        # åˆå§‹åŒ–åƒé—®å®¢æˆ·ç«¯
        self.client = OpenAI(
            api_key=os.getenv("QWEN_API_KEY", "sk-90224d784fa94a06a5acedd7e152848d"),
            base_url="https://dashscope.aliyuncs.com/compatible-mode/v1"
        )
        
        # é˜¶æ®µå®šä¹‰JSON
        self.stages_json = """{
          "stages": [
            {
              "stage": "å¼€é¢˜é˜¶æ®µ",
              "purpose": "åˆ¤æ–­æ˜¯å¦å·²ç»å®Œæˆé€‰é¢˜ã€ç«‹é¢˜ä¸ç ”ç©¶æ–¹æ¡ˆè®¾è®¡ï¼Œå¯æ­£å¼è¿›å…¥ç ”ç©¶é˜¶æ®µ",
              "checklist": {
                "é€‰é¢˜é˜¶æ®µï¼ˆTopic Selectionï¼‰": [
                  "å·²åœ¨ä¸“ä¸š/å¯¼å¸ˆæ–¹å‘èŒƒå›´å†…ç¡®å®šé€‰é¢˜é¢†åŸŸï¼ˆä¾‹å¦‚æœºå™¨äººã€AIã€æ§åˆ¶ç­‰ï¼‰",
                  "èƒ½è¯´æ˜é€‰é¢˜çš„ç°å®èƒŒæ™¯æˆ–ç§‘å­¦æ„ä¹‰ï¼ˆwhy this topic mattersï¼‰",
                  "å·²é˜…è¯»è‡³å°‘10ç¯‡æ ¸å¿ƒæ–‡çŒ®ï¼Œäº†è§£ä¸»æµæ–¹å‘ä¸æœ€æ–°æˆæœ",
                  "èƒ½æ˜ç¡®å½“å‰ç ”ç©¶ç©ºç¼ºæˆ–ç—›ç‚¹ï¼ˆwhat's missingï¼‰",
                  "é€‰é¢˜éš¾åº¦ã€åˆ›æ–°æ€§ã€èµ„æºéœ€æ±‚å‡åœ¨å¯æ‰¿å—èŒƒå›´å†…ï¼ˆnot too easy / not too ambitiousï¼‰",
                  "å¯¼å¸ˆè®¤å¯è¯¥é¢˜ç›®å…·å¤‡ç ”ç©¶/åº”ç”¨ä»·å€¼ï¼ˆè¾¾åˆ°'å¯ä»¥å†™å¼€é¢˜æŠ¥å‘Š'æ ‡å‡†ï¼‰"
                ],
                "ç«‹é¢˜ä¸é—®é¢˜å®šä¹‰ï¼ˆProblem Definitionï¼‰": [
                  "èƒ½ç”¨1-2å¥è¯æ¸…æ™°è¡¨è¿°ç ”ç©¶é—®é¢˜ï¼ˆresearch question / hypothesisï¼‰",
                  "ç ”ç©¶ç›®æ ‡æ˜ç¡®ä¸”å¯é‡åŒ–ï¼ˆä¾‹å¦‚'æå‡xæ€§èƒ½''é™ä½yè¯¯å·®''éªŒè¯zå‡è®¾'ï¼‰",
                  "çŸ¥é“ç ”ç©¶è¦è§£å†³çš„é—®é¢˜ç±»å‹ï¼ˆç†è®ºã€ç®—æ³•ã€å®éªŒã€å·¥ç¨‹åº”ç”¨ç­‰ï¼‰",
                  "èƒ½è§£é‡Š'ä¸ºä»€ä¹ˆæ˜¯ä½ æ¥åš'ï¼ˆå·²æœ‰åŸºç¡€ã€èµ„æºæˆ–å…´è¶£åŒ¹é…ï¼‰"
                ],
                "ç ”ç©¶æ–¹æ¡ˆè®¾è®¡ï¼ˆMethod Designï¼‰": [
                  "å·²ç¡®å®šä¸»è¦ç ”ç©¶æ–¹æ³•ï¼ˆå®éªŒ/å»ºæ¨¡/ä»¿çœŸ/æ•°æ®åˆ†æ/ç³»ç»Ÿå®ç°ç­‰ï¼‰",
                  "å·²è¯†åˆ«å…³é”®å˜é‡ã€æ§åˆ¶å› ç´ ä¸è¯„ä¼°æŒ‡æ ‡ï¼ˆmetricsï¼‰",
                  "åˆæ­¥ç¡®å®šæ•°æ®æ¥æº / ç¡¬ä»¶è®¾å¤‡ / è½¯ä»¶å·¥å…· / ç®—åŠ›å¹³å°ç­‰",
                  "å½¢æˆåˆæ­¥ç ”ç©¶è·¯çº¿å›¾ï¼ˆåŒ…å«æ¨¡å—åˆ’åˆ†æˆ–ä»»åŠ¡åˆ†è§£ï¼‰",
                  "æ˜ç¡®é¢„æœŸæˆæœå½¢å¼ï¼ˆè®ºæ–‡ã€ç³»ç»Ÿã€ç®—æ³•ã€ä¸“åˆ©ã€è°ƒç ”æŠ¥å‘Šç­‰ï¼‰"
                ],
                "å¯è¡Œæ€§ä¸æ—¶é—´è§„åˆ’ï¼ˆFeasibility & Scheduleï¼‰": [
                  "å·²åˆ¶å®šé˜¶æ®µæ€§æ—¶é—´è¡¨ï¼ˆå«å…³é”®é‡Œç¨‹ç¢‘å’Œäº¤ä»˜ç‰©ï¼‰",
                  "å·²è¯„ä¼°é£é™©ç‚¹ï¼ˆå¦‚å®éªŒå¤±è´¥ã€æ•°æ®ä¸è¶³ã€è®¡ç®—èµ„æºé—®é¢˜ç­‰ï¼‰å¹¶æå‡ºåº”å¯¹æ–¹æ¡ˆ",
                  "å¯¼å¸ˆå¯¹è®¡åˆ’è®¤å¯ä¸”å»ºè®®æ–¹å‘å¯è¡Œ",
                  "å‡†å¤‡äº†å¼€é¢˜æŠ¥å‘Šåˆç¨¿å’Œæ±‡æŠ¥ææ–™ï¼ˆå«ç ”ç©¶èƒŒæ™¯ã€æ„ä¹‰ã€æ–¹æ³•ã€è®¡åˆ’ï¼‰"
                ]
              }
            },
            {
              "stage": "ä¸­æœŸé˜¶æ®µ",
              "purpose": "åˆ¤æ–­æ˜¯å¦æ ¸å¿ƒç ”ç©¶å·¥ä½œå·²ç»å®è´¨æ¨è¿›ï¼Œæœ‰ä¸­æœŸæˆæœ",
              "checklist": {
                "ç ”ç©¶è¿›å±•": [
                  "æ ¸å¿ƒç®—æ³•/ç³»ç»Ÿ/å®éªŒå¹³å°å·²æ­å»ºå®Œæ¯•å¹¶èƒ½æ­£å¸¸è¿è¡Œ",
                  "å·²æœ‰ç¬¬ä¸€æ‰¹å®éªŒç»“æœæˆ–ç³»ç»ŸåŠŸèƒ½å¯å±•ç¤º",
                  "é‡åˆ°çš„ä¸»è¦é—®é¢˜å·²è¢«è¯†åˆ«ï¼ˆæ•°æ®ã€å‚æ•°ã€æ”¶æ•›ã€ç¡¬ä»¶ç­‰ï¼‰"
                ],
                "è·¯å¾„ä¸èŠ‚å¥": [
                  "æ˜ç¡®åç»­ä¼˜åŒ–æ–¹å‘ï¼ˆä¾‹å¦‚æ¨¡å‹è°ƒä¼˜ã€ç‰¹å¾æ”¹è¿›ã€æ–¹æ³•å¯¹æ¯”ï¼‰",
                  "èƒ½å±•ç¤ºé˜¶æ®µæ€§æˆæœå›¾è¡¨/è§†é¢‘/ç»“æœ",
                  "ä¿æŒæ¯å‘¨æˆ–åŒå‘¨ä¾‹ä¼šæ›´æ–°è¿›å±•"
                ],
                "é£é™©ä¸è°ƒæ•´": [
                  "å·²è¯„ä¼°å½“å‰è®¡åˆ’èƒ½å¦å¦‚æœŸå®Œæˆï¼Œå¦‚æœ‰å¿…è¦å·²è°ƒæ•´æ–¹å‘æˆ–ç›®æ ‡",
                  "å¯¼å¸ˆå¯¹å½“å‰è¿›åº¦æ€»ä½“æ»¡æ„ï¼Œæœªå‡ºç°é•¿æœŸåœæ»"
                ]
              }
            },
            {
              "stage": "ç»“é¢˜é˜¶æ®µ",
              "purpose": "åˆ¤æ–­æ˜¯å¦è¿›å…¥æ”¶å°¾ä¸è®ºæ–‡å†™ä½œé˜¶æ®µ",
              "checklist": {
                "ç ”ç©¶ç»“æœå®Œå–„": [
                  "æ ¸å¿ƒå®éªŒå®Œæˆ â‰¥80%ï¼Œä¸»è¦æ•°æ®å’Œå¯¹æ¯”å®éªŒé½å…¨",
                  "ç ”ç©¶ç»“æœå¯å¤ç°å¹¶æ”¯æŒä¸»è¦ç»“è®º",
                  "ç ”ç©¶è´¡çŒ®ç‚¹å·²å½¢æˆé—­ç¯ï¼ˆä»é—®é¢˜â†’æ–¹æ³•â†’ç»“æœâ†’éªŒè¯ï¼‰"
                ],
                "è®ºæ–‡æ’°å†™": [
                  "è®ºæ–‡å¤§çº²å·²ç¡®å®šï¼Œintroduction ä¸ method éƒ¨åˆ†åˆç¨¿å®Œæˆ",
                  "å·²æœ‰ä¸»è¦å›¾è¡¨ä¸å®éªŒå¯¹æ¯”ç»“æœ",
                  "å·²æ¢³ç†related workå¹¶æ˜ç¡®è‡ªå·±ç›¸å¯¹ä»–äººçš„åˆ›æ–°ç‚¹"
                ],
                "æ”¶å°¾å‡†å¤‡": [
                  "å‡†å¤‡ç»“é¢˜æŠ¥å‘Šã€æˆæœå±•ç¤ºæˆ–æ¼”ç¤ºè§†é¢‘",
                  "å¯¼å¸ˆå·²å®¡é˜…è®ºæ–‡åˆç¨¿å¹¶åé¦ˆä¿®æ”¹æ„è§",
                  "å‡†å¤‡è®ºæ–‡æŸ¥é‡ã€æŠ•ç¨¿æˆ–å½’æ¡£ææ–™"
                ]
              }
            },
            {
              "stage": "ç­”è¾©é˜¶æ®µ",
              "purpose": "åˆ¤æ–­æ˜¯å¦å…·å¤‡è‡ªä¿¡å±•ç¤ºä¸ç­”è¾©çš„å‡†å¤‡åº¦",
              "checklist": {
                "å±•ç¤ºå‡†å¤‡": [
                  "ç­”è¾©PPTå·²å®Œæˆï¼ˆç»“æ„æ¸…æ™°ï¼šèƒŒæ™¯â†’é—®é¢˜â†’æ–¹æ³•â†’ç»“æœâ†’è´¡çŒ®ï¼‰",
                  "å·²è¿›è¡Œè‡³å°‘ä¸€æ¬¡æ¨¡æ‹Ÿç­”è¾©ï¼Œç†Ÿæ‚‰æ—¶é—´æ§åˆ¶ä¸èŠ‚å¥",
                  "èƒ½æ¸…æ™°è®²è¿°ç ”ç©¶åŠ¨æœºã€æ–¹æ³•é€»è¾‘ã€ç»“æœæ„ä¹‰"
                ],
                "é—®ç­”åº”å¯¹": [
                  "å‡†å¤‡äº†å¸¸è§ç­”è¾©é—®é¢˜ï¼šåˆ›æ–°ç‚¹ã€æ–¹æ³•ç»†èŠ‚ã€å±€é™æ€§ã€æœªæ¥æ–¹å‘",
                  "èƒ½å†·é™åº”å¯¹è´¨ç–‘å’Œå»¶ä¼¸æ€§é—®é¢˜",
                  "èƒ½æŠŠæŠ€æœ¯å†…å®¹è®²ç»™éæœ¬é¢†åŸŸå¬ä¼—ç†è§£"
                ],
                "åç»­æ”¶å°¾": [
                  "æ ¹æ®è¯„å§”æ„è§å®Œæˆè®ºæ–‡æœ€ç»ˆä¿®æ”¹",
                  "å½’æ¡£æ‰€æœ‰æˆæœï¼šè®ºæ–‡ã€ä»£ç ã€å®éªŒè®°å½•ã€PPTã€è§†é¢‘ç­‰",
                  "å‡†å¤‡æˆæœå±•ç¤ºæˆ–ç”³æŠ¥ï¼ˆä¾‹å¦‚ä¼˜ç§€æ¯•ä¸šè®ºæ–‡ã€ç«èµ›ã€ä¸“åˆ©ç­‰ï¼‰"
                ]
              }
            }
          ]
        }"""
    
    def evaluate_research_progress(self, user_text, image_url=None, enable_thinking=True):
        """
        è°ƒç”¨åƒé—® qwen3-vl-plusï¼Œåˆ†æç ”ç©¶ç”Ÿè®ºæ–‡é˜¶æ®µã€ä»»åŠ¡è¿›åº¦ã€å»ºè®®ã€å¯¼å¸ˆæ„å›¾ã€‚
        è¿”å› JSON dict: current_stage, tasks_progress, advice, mentor_insights
        """
        system_prompt = f"""
ä½ æ˜¯ä¸€ä¸ªç ”ç©¶ç”Ÿå­¦æœ¯æŒ‡å¯¼åŠ©æ‰‹ï¼Œä¸“é—¨å¸®åŠ©å­¦ç”Ÿè¯„ä¼°è®ºæ–‡è¿›åº¦ã€ç†è§£å¯¼å¸ˆæ„å›¾ï¼Œå¹¶æä¾›æ”¹è¿›å’Œæ²Ÿé€šå»ºè®®ã€‚
è¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š

1. æ ¹æ®å­¦ç”Ÿæä¾›çš„æ–‡æœ¬ä¿¡æ¯å’Œå›¾ç‰‡ï¼ˆå¯¼å¸ˆæ²Ÿé€šè®°å½•ï¼‰åˆ¤æ–­å½“å‰è®ºæ–‡é˜¶æ®µï¼š
   - å¼€é¢˜é˜¶æ®µ
   - ä¸­æœŸé˜¶æ®µ
   - ç»“é¢˜é˜¶æ®µ
   - ç­”è¾©é˜¶æ®µ

2. å¯¹å½“å‰é˜¶æ®µçš„å„å­ä»»åŠ¡ï¼ˆchecklistï¼‰è¿›è¡Œé‡åŒ–è¯„ä¼°ï¼Œç”¨ 0~1 çš„æ•°å­—è¡¨ç¤ºå®Œæˆç¨‹åº¦ã€‚
   - æ•°å­—è¶Šæ¥è¿‘1è¡¨ç¤ºè¯¥å­ä»»åŠ¡å·²å®Œæˆå¾—è¶Šå……åˆ†ï¼Œ0è¡¨ç¤ºå°šæœªå¼€å§‹ã€‚
   - ä»…å¯¹å½“å‰é˜¶æ®µçš„ checklist è¿›è¡Œé‡åŒ–ã€‚

3. æ ¹æ®é˜¶æ®µå’Œå­ä»»åŠ¡è¿›åº¦ï¼Œç”Ÿæˆå…·ä½“å¯æ“ä½œçš„å»ºè®®ï¼Œå¸®åŠ©å­¦ç”Ÿæ¨è¿›è®ºæ–‡ã€‚

4. ç†è§£å¯¼å¸ˆæ„æ€ï¼š
   - åˆ†æå¯¼å¸ˆæ²Ÿé€šè®°å½•æˆ–å›¾ç‰‡å†…å®¹ï¼Œæç‚¼æ ¸å¿ƒå…³æ³¨ç‚¹å’Œå»ºè®®ã€‚
   - ç»™å‡ºå­¦ç”Ÿå¯æ‰§è¡Œçš„æ²Ÿé€šç­–ç•¥ã€‚

5. è¾“å‡ºå¿…é¡»ä¸¥æ ¼æŒ‰ç…§ JSON ç»“æ„ï¼š
{{
  "current_stage": "å¼€é¢˜é˜¶æ®µ/ä¸­æœŸé˜¶æ®µ/ç»“é¢˜é˜¶æ®µ/ç­”è¾©é˜¶æ®µ",
  "tasks_progress": {{
    "å­ä»»åŠ¡åç§°": å®Œæˆåº¦(0~1),
    ...
  }},
  "advice": "å¯æ“ä½œå»ºè®®æ–‡æœ¬",
  "mentor_insights": "å¯¼å¸ˆæ„è§è§£è¯»åŠæ²Ÿé€šå»ºè®®"
}}

6. ç†è§£é˜¶æ®µåŠå­ä»»åŠ¡ä¿¡æ¯å¦‚ä¸‹ï¼š
{self.stages_json}
"""

        messages = [{"role": "system", "content": system_prompt}]

        user_content = [{"type": "text", "text": user_text}]
        if image_url:
            user_content.insert(0, {"type": "image_url", "image_url": {"url": image_url}})

        messages.append({"role": "user", "content": user_content})

        try:
            completion = self.client.chat.completions.create(
                model="qwen3-vl-plus",
                messages=messages,
                stream=False,
                extra_body={"enable_thinking": enable_thinking, "thinking_budget": 81920}
            )

            content = completion.choices[0].message.content
            try:
                result = json.loads(content)
            except json.JSONDecodeError:
                result = {"raw_output": content, "error": "JSONè§£æå¤±è´¥"}
                
        except Exception as e:
            result = {"error": f"APIè°ƒç”¨å¤±è´¥: {str(e)}"}
        
        return result
    
    def show_evaluation_interface(self):
        """
        æ˜¾ç¤ºç ”ç©¶è¿›åº¦è¯„ä¼°ç•Œé¢
        """
        st.markdown("### ğŸ“Š ç ”ç©¶è¿›åº¦æ™ºèƒ½è¯„ä¼°")
        
        # ç”¨æˆ·è¾“å…¥åŒºåŸŸ
        user_text = st.text_area(
            "æè¿°æ‚¨çš„ç ”ç©¶è¿›åº¦å’Œé‡åˆ°çš„é—®é¢˜ï¼š",
            placeholder="ä¾‹å¦‚ï¼šæˆ‘å·²ç»å®Œæˆå¼€é¢˜æ–‡çŒ®é˜…è¯»å’Œå®éªŒæ–¹æ¡ˆåˆæ­¥è®¾è®¡ï¼Œä½†æ¨¡æ‹Ÿå®éªŒè¿˜æœªå®Œæˆ...",
            height=150
        )
        
        # å›¾ç‰‡ä¸Šä¼ ï¼ˆå¯é€‰ï¼‰
        uploaded_file = st.file_uploader(
            "ä¸Šä¼ å¯¼å¸ˆæ²Ÿé€šè®°å½•æˆªå›¾ï¼ˆå¯é€‰ï¼‰", 
            type=['png', 'jpg', 'jpeg'],
            help="å¯ä»¥ä¸Šä¼ ä¸å¯¼å¸ˆçš„èŠå¤©è®°å½•ã€é‚®ä»¶æˆªå›¾ç­‰"
        )
        
        image_url = None
        if uploaded_file is not None:
            # åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œéœ€è¦å°†æ–‡ä»¶ä¸Šä¼ åˆ°å›¾åºŠå¹¶è·å–URL
            # ç›®å‰å…ˆæ˜¾ç¤ºé¢„è§ˆ
            st.image(uploaded_file, caption="ä¸Šä¼ çš„å›¾ç‰‡", use_column_width=True)
            st.info("å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½éœ€è¦é…ç½®å›¾åºŠæœåŠ¡ï¼Œç›®å‰ä»…ä½œé¢„è§ˆ")
        
        # è¯„ä¼°æŒ‰é’®
        if st.button("ğŸ” æ™ºèƒ½è¯„ä¼°ç ”ç©¶è¿›åº¦", use_container_width=True):
            if not user_text.strip():
                st.error("è¯·è¾“å…¥æ‚¨çš„ç ”ç©¶è¿›åº¦æè¿°")
                return
            
            with st.spinner("æ­£åœ¨åˆ†ææ‚¨çš„ç ”ç©¶è¿›åº¦..."):
                result = self.evaluate_research_progress(user_text, image_url)
            
            # æ˜¾ç¤ºè¯„ä¼°ç»“æœ
            self._display_evaluation_result(result)
    
    def _display_evaluation_result(self, result):
        """
        æ˜¾ç¤ºè¯„ä¼°ç»“æœ
        """
        if "error" in result:
            st.error(f"è¯„ä¼°å¤±è´¥: {result['error']}")
            if "raw_output" in result:
                st.text_area("åŸå§‹è¾“å‡º", result["raw_output"], height=200)
            return
        
        # æ˜¾ç¤ºå½“å‰é˜¶æ®µ
        current_stage = result.get("current_stage", "æœªçŸ¥é˜¶æ®µ")
        st.markdown(f"#### ğŸ“ å½“å‰é˜¶æ®µ: **{current_stage}**")
        
        # æ˜¾ç¤ºä»»åŠ¡è¿›åº¦
        tasks_progress = result.get("tasks_progress", {})
        if tasks_progress:
            st.markdown("#### ğŸ“ˆ ä»»åŠ¡å®Œæˆåº¦")
            
            for task_name, progress in tasks_progress.items():
                progress_percent = int(progress * 100)
                st.markdown(f"**{task_name}**")
                st.progress(progress, text=f"{progress_percent}%")
        
        # æ˜¾ç¤ºå»ºè®®
        advice = result.get("advice", "")
        if advice:
            st.markdown("#### ğŸ’¡ æ”¹è¿›å»ºè®®")
            st.info(advice)
        
        # æ˜¾ç¤ºå¯¼å¸ˆæ´å¯Ÿ
        mentor_insights = result.get("mentor_insights", "")
        if mentor_insights:
            st.markdown("#### ğŸ‘¨â€ğŸ« å¯¼å¸ˆæ„å›¾è§£è¯»")
            st.warning(mentor_insights)
        
        # æ˜¾ç¤ºåŸå§‹JSONï¼ˆè°ƒè¯•ç”¨ï¼‰
        with st.expander("ğŸ“‹ æŸ¥çœ‹è¯¦ç»†æ•°æ®"):
            st.json(result)

# åˆ›å»ºå…¨å±€è¯„ä¼°å™¨å®ä¾‹
research_evaluator = ResearchEvaluator()